\NeedsTeXFormat{LaTeX2e}

\RequirePackage{graphicx}
\RequirePackage{xstring}
\RequirePackage{xparse}
\RequirePackage[absolute,overlay]{textpos}

% Checks if input begins with http and creates either a direct link
% or uses the citelink command to reference the provided citation key
\DeclareRobustCommand{\makesourcelink}[1]{%
  \par\vspace{1pt }\centering
    {\tiny \sourceref{#1}}%
}

% ------------------------------------------------------------------------
% Image helpers for various alignments, including attribution
% ------------------------------------------------------------------------
% DeclareDocumentCommand is more flexible and available in LaTeX without the xparse package since 2020 or so
% Usage: 
% - \image{file.png}
% - \image[0.5]{file.png}
% - \image[0.5][CITEKEY]{file.png}
% - Variants for horizontal alignment with L, C, R suffixes used analogously

% Main image macro with optional width and attribution
% #1 (optional) = width factor (default 1.0)
% #2 (optional) = source attribution (CITEKEY or URL)
% #3 (required) = image path
\DeclareDocumentCommand{\image}{O{1} o m}{%
  \includegraphics[width=#1\textwidth]{#3}%
  \IfValueT{#2}{%
    \makesourcelink{#2}%
  }%
}

% Centered image variant
\DeclareDocumentCommand{\imageC}{O{1} o m}{%
  \begin{center}
    \begin{minipage}{#1\textwidth}
      \centering
      \includegraphics[width=\linewidth]{#3}%
      \IfValueT{#2}{%
        \makesourcelink{#2}%
      }%
    \end{minipage}%
  \end{center}%
}

% Left-aligned image variant
\DeclareDocumentCommand{\imageL}{O{1} o m}{%
  \begin{flushleft}
    \begin{minipage}{#1\textwidth}
      \raggedright
      \includegraphics[width=\linewidth]{#3}%
      \IfValueT{#2}{%
        \makesourcelink{#2}%
      }%
    \end{minipage}%
  \end{flushleft}%
}

% Right-aligned image variant
\DeclareDocumentCommand{\imageR}{O{1} o m}{%
  \begin{flushright}
    \begin{minipage}{#1\textwidth}
      \raggedleft
      \includegraphics[width=\linewidth]{#3}%
      \IfValueT{#2}{%
        \makesourcelink{#2}%
      }%
    \end{minipage}%
  \end{flushright}%
}

% Fixed-position image using absolute coordinates via textpos
% Usage examples:
% - \imageFixed{2cm}{3cm}[0.6]{file.png}
% - \imageFixed{0.1\paperwidth}{0.2\paperheight}[0.5][CITEKEY]{file.png}
% Args:
%   #1 = x position (length, from left; e.g., 2cm or 0.1\paperwidth)
%   #2 = y position (length, from top; e.g., 3cm or 0.2\paperheight)
%   #3 (optional) = width factor relative to \textwidth (default 1)
%   #4 (optional) = source attribution (CITEKEY or URL)
%   #5 (required) = image path
\DeclareDocumentCommand{\imageFixed}{m m O{1} o m}{%
  \begin{textblock*}{#3\textwidth}(#1,#2)
    \begin{minipage}{#3\textwidth}
      \includegraphics[width=\linewidth]{#5}%
      \IfValueT{#4}{%
        \makesourcelink{#4}%
      }%
    \end{minipage}%
  \end{textblock*}%
}
